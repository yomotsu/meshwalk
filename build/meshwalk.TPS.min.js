!function(t,i){"use strict";i.CharacterController=function(e,s){Object.assign(i.CharacterController.prototype,i.EventDispatcher.prototype),this.object=e,this.center=this.object.position.clone(),this.radius=s,this.groundPadding=.5,this.maxSlopeGradient=Math.cos(t.Math.degToRad(50)),this.isGrounded=!1,this.isOnSlope=!1,this.isIdling=!1,this.isRunning=!1,this.isJumping=!1,this.direction=0,this.movementSpeed=10,this.velocity=new t.Vector3(0,-10,0),this.currentJumpPower=0,this.jumpStartTime=0,this.groundHeight=0,this.groundNormal=new t.Vector3,this.collisionCandidate,this.contactInfo=[]},i.CharacterController.prototype={constructor:i.CharacterController,update:function(t){this.isGrounded=!1,this.isOnSlope=!1,this.groundHeight=-1/0,this.groundNormal.set(0,1,0),this.updateGrounding(),this.updateJumping(),this.updatePosition(t),this.collisionDetection(),this.solvePosition(),this.updateVelocity(),this.events()},updateVelocity:function(){var i,e,s,n,o,h,a,r,c=-20,d=-Math.cos(this.direction),u=-Math.sin(this.direction),l=!1;if(this.velocity.set(u*this.movementSpeed*this.isRunning,c,d*this.movementSpeed*this.isRunning),0!==this.contactInfo.length||this.isJumping){if(!this.isGrounded||this.isOnSlope||this.isJumping)if(this.isOnSlope){var p=c,m=-p/(1-this.groundNormal.y)*.2;this.velocity.x=this.groundNormal.x*m,this.velocity.y=c,this.velocity.z=this.groundNormal.z*m}else this.isGrounded||this.isOnSlope||!this.isJumping||(this.velocity.y=this.currentJumpPower*-c);else this.velocity.y=0;for(s=new t.Vector2(u,d),o=Math.atan2(s.y,s.x),h=Math.atan2(-s.y,-s.x),a=0,r=this.contactInfo.length;r>a;a++)i=this.contactInfo[a].face.normal,this.maxSlopeGradient<i.y||this.isOnSlope||(!l&&i.y<0&&(l=!0),e=new t.Vector2(i.x,i.z).normalize(),n=Math.atan2(e.y,e.x),Math.abs(h-n)>=.5*Math.PI&&Math.abs(h-n)<=1.5*Math.PI||(e.set(s.dot(e)*e.x,s.dot(e)*e.y),s.subVectors(s,e),this.velocity.x=s.x*this.movementSpeed*this.isRunning,this.velocity.z=s.y*this.movementSpeed*this.isRunning));l&&(this.velocity.y=Math.min(0,this.velocity.y),this.isJumping=!1)}},updateGrounding:function(){var e,s,n,o,h=this.collisionCandidate,a=new t.Vector3(this.center.x,this.center.y+this.radius,this.center.z),r=new t.Vector3(this.center.x,this.center.y-1e10,this.center.z);for(e=0,s=h.length;s>e;e++)o=i.collision.testSegmentTriangle(a,r,h[e].a,h[e].b,h[e].c),o&&!n?(n=o,n.face=h[e]):o&&o.contactPoint.y>n.contactPoint.y&&(n=o,n.face=h[e]);if(n){this.groundHeight=n.contactPoint.y,this.groundNormal.copy(n.face.normal);var c=a.y,d=this.center.y-this.radius-this.groundPadding;if(this.isJumping&&0<this.currentJumpPower)return this.isOnSlope=!1,this.isGrounded=!1,void 0;this.isGrounded=d<=this.groundHeight&&this.groundHeight<=c,this.isOnSlope=this.groundNormal.y<=this.maxSlopeGradient,this.isGrounded&&(this.isJumping=!1)}},updatePosition:function(t){var i=this.center.x+this.velocity.x*t,e=this.center.y+this.velocity.y*t,s=this.center.z+this.velocity.z*t;this.isGrounded&&(e=this.groundHeight+this.radius),this.center.set(i,e,s)},collisionDetection:function(){var t,e,s,n=this.collisionCandidate;for(this.contactInfo.length=0,t=0,e=n.length;e>t;t++)s=i.collision.isIntersectionSphereTriangle(this,n[t].a,n[t].b,n[t].c,n[t].normal),s&&(s.face=n[t],this.contactInfo.push(s))},solvePosition:function(){var i,e,s,n,o,h,a,r=new t.Vector3,c=new t.Vector3,d=new t.Vector3,u=new t.Vector3,l=new t.Vector3;if(0===this.contactInfo.length)return this.object.position.copy(this.center),void 0;for(h=0,a=this.contactInfo.length;a>h;h++)if(i=this.contactInfo[h].face,e=this.contactInfo[h].face.normal,s=this.contactInfo[h].distance,!(this.maxSlopeGradient<e.y)){var p=this.maxSlopeGradient<=i.normal.y&&i.normal.y<1;this.isJumping&&0>=this.currentJumpPower&&p&&(this.isJumping=!1,this.isGrounded=!0),(this.isGrounded||this.isOnSlope)&&(r.copy(e).multiplyScalar(-this.radius).add(this.center),d.set(e.x,0,e.z).normalize(),n=i.a.dot(e),o=(n-(e.x*r.x+e.y*r.y+e.z*r.z))/(e.x*d.x+e.y*d.y+e.z*d.z),c.copy(d).multiplyScalar(o).add(r),u.subVectors(c,r),Math.abs(l.x)>Math.abs(u.x)&&(l.x+=u.x),Math.abs(l.z)>Math.abs(u.z)&&(l.z+=u.z))}this.center.add(l),this.object.position.copy(this.center)},events:function(){var t,i,e,s,n,o=!0;return function(){return o?(o=!1,t=this.isGrounded,i=this.isOnSlope,e=this.isIdling,s=this.isRunning,n=this.isJumping,void 0):(s||this.isRunning||!this.isGrounded||this.isIdling?!s&&this.isRunning&&!this.isJumping&&this.isGrounded||!t&&this.isGrounded&&this.isRunning||i&&!this.isOnSlope&&this.isRunning&&this.isGrounded?(this.isIdling=!1,this.dispatchEvent({type:"startWalking"})):!n&&this.isJumping?(this.isIdling=!1,this.dispatchEvent({type:"startJumping"})):!i&&this.isOnSlope?this.dispatchEvent({type:"startSliding"}):!t||this.isGrounded||this.isJumping||this.dispatchEvent({type:"startFalling"}):(this.isIdling=!0,this.dispatchEvent({type:"startIdling"})),!t&&this.isGrounded,t=this.isGrounded,i=this.isOnSlope,e=this.isIdling,s=this.isRunning,n=this.isJumping,void 0)}}(),setDirection:function(){},jump:function(){this.isJumping||!this.isGrounded||this.isOnSlope||(this.jumpStartTime=Date.now(),this.currentJumpPower=1,this.isJumping=!0)},updateJumping:function(){var t=1e3;if(this.isJumping){var i=Date.now()-this.jumpStartTime,e=i/t;this.currentJumpPower=Math.cos(Math.min(e,1)*Math.PI)}}}}(THREE,MW),MW.AnimationController=function(t){this.mesh=t,this.motion={},this.mixer=new THREE.AnimationMixer(t),this.currentMotionName="";var i,e,s;for(i=0,e=this.mesh.geometry.animations.length;e>i;i++)s=this.mesh.geometry.animations[i],this.motion[s.name]=this.mixer.clipAction(s),this.motion[s.name].setEffectiveWeight(1)},MW.AnimationController.prototype={play:function(t){if(this.currentMotionName!==t){if(this.motion[this.currentMotionName]){var i=this.motion[this.currentMotionName].play(),e=this.motion[t].play();i.enabled=!0,e.enabled=!0,i.crossFadeTo(e,.3)}else this.motion[t].enabled=!0,this.motion[t].play();this.currentMotionName=t}},turn:function(){var t=200,i=2*Math.PI,e=function(t,i){return(t%i+i)%i},s=function(t,s){var n=e(t-s,i),o=e(s-t,i);return o>n?-n:o};return function(i,e){var n=this,o=0,h=this.mesh.rotation.y,a=i,r=s(h,a),c=Date.now(),d=c+t;return e?(this.mesh.rotation.y=a,void 0):(this._targetRotY!==a&&(this._targetRotY=a,function(){var i=a;!function e(){var s=Date.now(),a=i!==n._targetRotY;if(!a){if(s>=d)return n.mesh.rotation.y=i,delete n._targetRotY,void 0;requestAnimationFrame(e),o=(s-c)/t,n.mesh.rotation.y=h+r*o}}()}()),void 0)}}(),update:function(t){this.mixer.update(t)}},function(t,i){"use strict";function e(t){if(!this.isDisabled){switch(t.keyCode){case o:case h:this.isUp=!0;break;case a:case r:this.isDown=!0;break;case c:case d:this.isLeft=!0;break;case u:case l:this.isRight=!0;break;case p:this.jump();break;default:return}var i=this.frontAngle;this.updateAngle(),i!==this.frontAngle&&this.dispatchEvent({type:"movekeychange"}),(this.isUp||this.isDown||this.isLeft||this.isRight)&&!this.isMoveKeyHolded&&(this.isMoveKeyHolded=!0,this.dispatchEvent({type:"movekeyon"}))}}function s(t){if(!this.isDisabled){switch(t.keyCode){case o:case h:this.isUp=!1;break;case a:case r:this.isDown=!1;break;case c:case d:this.isLeft=!1;break;case u:case l:this.isRight=!1;break;case p:break;default:return}var i=this.frontAngle;this.updateAngle(),i!==this.frontAngle&&this.dispatchEvent({type:"movekeychange"}),this.isUp||this.isDown||this.isLeft||this.isRight||t.keyCode!==o&&t.keyCode!==h&&t.keyCode!==a&&t.keyCode!==r&&t.keyCode!==c&&t.keyCode!==d&&t.keyCode!==u&&t.keyCode!==l||(this.isMoveKeyHolded=!1,this.dispatchEvent({type:"movekeyoff"}))}}function n(){this.isUp=!1,this.isDown=!1,this.isLeft=!1,this.isRight=!1,this.isMoveKeyHolded&&(this.isMoveKeyHolded=!1,this.dispatchEvent({type:"movekeyoff"}))}{var o=87,h=38,a=83,r=40,c=65,d=37,u=68,l=39,p=32,m=t.Math.degToRad(0),g=t.Math.degToRad(45),y=t.Math.degToRad(90),f=t.Math.degToRad(135),v=t.Math.degToRad(180),M=t.Math.degToRad(225),w=t.Math.degToRad(270),b=t.Math.degToRad(315);t.Math.degToRad(360)}i.KeyInputControl=function(){Object.assign(i.KeyInputControl.prototype,i.EventDispatcher.prototype),this.isDisabled=!1,this.isUp=!1,this.isDown=!1,this.isLeft=!1,this.isRight=!1,this.isMoveKeyHolded=!1,this.frontAngle=0,this._keydownListener=e.bind(this),this._keyupListener=s.bind(this),this._blurListener=n.bind(this),window.addEventListener("keydown",this._keydownListener,!1),window.addEventListener("keyup",this._keyupListener,!1),window.addEventListener("blur",this._blurListener,!1)},i.KeyInputControl.prototype.jump=function(){this.dispatchEvent({type:"jumpkeypress"})},i.KeyInputControl.prototype.updateAngle=function(){var t=this.isUp,i=this.isDown,e=this.isLeft,s=this.isRight;!t||e||i||s?t&&e&&!i&&!s?this.frontAngle=g:t||!e||i||s?!t&&e&&i&&!s?this.frontAngle=f:t||e||!i||s?!t&&!e&&i&&s?this.frontAngle=M:t||e||i||!s?t&&!e&&!i&&s&&(this.frontAngle=b):this.frontAngle=w:this.frontAngle=v:this.frontAngle=y:this.frontAngle=m}}(THREE,MW),function(t,i){"use strict";function e(t){this.dispatchEvent({type:"mousedown"}),this._pointerStart.x=t.clientX,this._pointerStart.y=t.clientY,this._pointerLast.x=this.lon,this._pointerLast.y=this.lat,this.el.removeEventListener("mousemove",this._mousedragListener,!1),this.el.addEventListener("mousemove",this._mousedragListener,!1),document.body.className+=" js-TPSCameraDragging"}function s(){this.dispatchEvent({type:"mouseup"}),this.el.removeEventListener("mousemove",this._mousedragListener,!1),document.body.className=document.body.className.replace(/ js-TPSCameraDragging/,"")}function n(t){var i=this.el.offsetWidth,e=this.el.offsetHeight,s=(this._pointerStart.x-t.clientX)/i*2,n=(this._pointerStart.y-t.clientY)/e*2;this.setLatLon(this._pointerLast.y+n*this.mouseAccelerationY,this._pointerLast.x+s*this.mouseAccelerationX)}function o(t){t.preventDefault(),t.wheelDeltaY?this.radius-=.05*t.wheelDeltaY/5:t.wheelDelta?this.radius-=.05*t.wheelDelta/5:t.detail&&(this.radius+=t.detail/5),this.radius=Math.max(this.radius,this.minRadius),this.radius=Math.min(this.radius,this.maxRadius)}var h=2*Math.PI,a=Math.PI/2;i.TPSCameraControl=function(h,a,r){Object.assign(i.TPSCameraControl.prototype,i.EventDispatcher.prototype),this.camera=h,this.trackObject=a,this.el=r&&r.el||document.body,this.offset=r&&r.offset||new t.Vector3(0,0,0),this.radius=r&&r.radius||10,this.minRadius=r&&r.minRadius||1,this.maxRadius=r&&r.maxRadius||30,this.rigidObjects=r&&r.rigidObjects||[],this.lat=0,this.lon=0,this.phi=0,this.theta=0,this.mouseAccelerationX=r&&void 0!==r.mouseAccelerationX?r.mouseAccelerationX:100,this.mouseAccelerationY=r&&void 0!==r.mouseAccelerationY?r.mouseAccelerationY:30,this._pointerStart={x:0,y:0},this._pointerLast={x:0,y:0},this.setNearPlainCornersWithPadding(),this.update(),this._mousedownListener=e.bind(this),this._mouseupListener=s.bind(this),this._mousedragListener=n.bind(this),this._scrollListener=o.bind(this),this.el.addEventListener("mousedown",this._mousedownListener,!1),this.el.addEventListener("mouseup",this._mouseupListener,!1),this.el.addEventListener("mousewheel",this._scrollListener,!1),this.el.addEventListener("DOMMouseScroll",this._scrollListener,!1)},i.TPSCameraControl.prototype={constructor:i.TPSCameraControl,update:function(){var i,e;this._center=new t.Vector3(this.trackObject.matrixWorld.elements[12]+this.offset.x,this.trackObject.matrixWorld.elements[13]+this.offset.y,this.trackObject.matrixWorld.elements[14]+this.offset.z),i=new t.Vector3(Math.cos(this.phi)*Math.cos(this.theta+a),Math.sin(this.phi),Math.cos(this.phi)*Math.sin(this.theta+a)),e=this.collisionTest(i.clone().normalize()),i.multiplyScalar(e),i.add(this._center),this.camera.position.copy(i),90===this.lat?this.camera.up.set(Math.cos(this.theta+Math.PI),0,Math.sin(this.theta+Math.PI)):-90===this.lat?this.camera.up.set(Math.cos(this.theta),0,Math.sin(this.theta)):this.camera.up.set(0,1,0),this.camera.lookAt(this._center),this.dispatchEvent({type:"updated"})},getFrontAngle:function(){return h+this.theta},setNearPlainCornersWithPadding:function(){var i=this.camera.near,e=.5*this.camera.fov,s=Math.tan(t.Math.degToRad(e))*i,n=s*this.camera.aspect;this.nearPlainCornersWithPadding=[new t.Vector3(-n-i,-s-i,0),new t.Vector3(n+i,-s-i,0),new t.Vector3(n+i,s+i,0),new t.Vector3(-n-i,s+i,0)]},setLatLon:function(i,e){this.lat=i>90?90:-90>i?-90:i,this.lon=0>e?360+e%360:e%360,this.phi=t.Math.degToRad(this.lat),this.theta=-t.Math.degToRad(this.lon)},collisionTest:function(i){var e,s,n,o,h,a=this.radius,r=new t.Matrix4,c=(new t.Matrix4).makeRotationX(this.phi),d=(new t.Matrix4).makeRotationY(this.theta);for(r.multiplyMatrices(c,d),e=0;4>e;e++)s=this.nearPlainCornersWithPadding[e].clone(),s.applyMatrix4(r),n=new t.Vector3(this._center.x+s.x,this._center.y+s.y,this._center.z+s.z),o=new t.Raycaster(n,i,this.camera.near,this.radius),h=o.intersectObjects(this.rigidObjects),0!==h.length&&h[0].distance<a&&(a=h[0].distance);return a}}}(THREE,MW);